/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","TYPO3/CMS/Core/Ajax/AjaxRequest"],(function(e,t){"use strict";let a=new class{constructor(){this.options={containerSelector:"#typo3-permissionList",editControllerSelector:"#PermissionControllerEdit"},this.ajaxUrl=TYPO3.settings.ajaxUrls.user_access_permissions,this.initializeEvents()}setCheck(e,t){if(document.editform[t]){let a=document.editform[t].value;for(let t=1;t<=5;t++)document.editform[e+"["+t+"]"].checked=a&Math.pow(2,t-1)}}checkChange(e,t){let a=0;for(let t=1;t<=5;t++)document.editform[e+"["+t+"]"].checked&&(a|=Math.pow(2,t-1));document.editform[t].value=a|("tx_beuser_system_beusertxpermission[check][perms_user]"===e?1:0),this.setCheck(e,t)}setPermissions(a){let r=a.data("page"),o=a.data("who"),n="#"+r+"_"+o;new t(this.ajaxUrl).post({page:r,who:o,permissions:a.data("permissions"),mode:a.data("mode"),bits:a.data("bits")}).then(async t=>{const a=await t.resolve();e(n).replaceWith(a),e(n).find("button").tooltip()})}toggleEditLock(a){let r=a.data("page");new t(this.ajaxUrl).post({action:"toggle_edit_lock",page:r,editLockState:a.data("lockstate")}).then(async t=>{e("#el_"+r).replaceWith(await t.resolve())})}changeOwner(a){let r=a.data("page");new t(this.ajaxUrl).post({action:"change_owner",page:r,ownerUid:a.data("owner"),newOwnerUid:e("#new_page_owner").val()}).then(async t=>{e("#o_"+r).replaceWith(await t.resolve())})}showChangeOwnerSelector(a){let r=a.data("page");new t(this.ajaxUrl).post({action:"show_change_owner_selector",page:r,ownerUid:a.data("owner"),username:a.data("username")}).then(async t=>{e("#o_"+r).replaceWith(await t.resolve())})}restoreOwner(t){let a=t.data("page"),r=t.data("username"),o=r;void 0===r&&(r=e("<span>",{class:"not_set",text:"[not set]"}),o=r.html(),r=r.text());let n=e("<span/>",{id:"o_"+a}),s=e("<a/>",{class:"ug_selector changeowner","data-page":a,"data-owner":t.data("owner"),"data-username":o,text:r});n.append(s),e("#o_"+a).replaceWith(n)}changeGroup(a){let r=a.data("page");new t(this.ajaxUrl).post({action:"change_group",page:r,groupUid:a.data("groupId"),newGroupUid:e("#new_page_group").val()}).then(async t=>{e("#g_"+r).replaceWith(await t.resolve())})}showChangeGroupSelector(a){let r=a.data("page");new t(this.ajaxUrl).post({action:"show_change_group_selector",page:r,groupUid:a.data("groupId"),groupname:a.data("groupname")}).then(async t=>{e("#g_"+r).replaceWith(await t.resolve())})}restoreGroup(t){let a=t.data("page"),r=t.data("groupname"),o=r;void 0===r&&(r=e("<span>",{class:"not_set",text:"[not set]"}),o=r.html(),r=r.text());let n=e("<span/>",{id:"g_"+a}),s=e("<a/>",{class:"ug_selector changegroup","data-page":a,"data-group":t.data("groupId"),"data-groupname":o,text:r});n.append(s),e("#g_"+a).replaceWith(n)}initializeEvents(){e(this.options.containerSelector).on("click",".change-permission",t=>{t.preventDefault(),this.setPermissions(e(t.currentTarget))}).on("click",".editlock",t=>{t.preventDefault(),this.toggleEditLock(e(t.currentTarget))}).on("click",".changeowner",t=>{t.preventDefault(),this.showChangeOwnerSelector(e(t.currentTarget))}).on("click",".changegroup",t=>{t.preventDefault(),this.showChangeGroupSelector(e(t.currentTarget))}).on("click",".restoreowner",t=>{t.preventDefault(),this.restoreOwner(e(t.currentTarget))}).on("click",".saveowner",t=>{t.preventDefault(),this.changeOwner(e(t.currentTarget))}).on("click",".restoregroup",t=>{t.preventDefault(),this.restoreGroup(e(t.currentTarget))}).on("click",".savegroup",t=>{t.preventDefault(),this.changeGroup(e(t.currentTarget))}),e(this.options.editControllerSelector).on("click","[data-check-change-permissions]",t=>{const a=e(t.currentTarget).data("checkChangePermissions").split(",").map(e=>e.trim());this.checkChange.apply(this,a)})}};return TYPO3.Permissions=a,a}));