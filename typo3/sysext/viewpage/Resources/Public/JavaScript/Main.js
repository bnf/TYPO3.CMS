/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","TYPO3/CMS/Backend/Storage/Persistent","jquery-ui/resizable"],(function(e,t){"use strict";var i;!function(e){e.resizableContainerIdentifier=".t3js-viewpage-resizeable",e.sizeIdentifier=".t3js-viewpage-size",e.moduleBodySelector=".t3js-module-body",e.customSelector=".t3js-preset-custom",e.customWidthSelector=".t3js-preset-custom",e.customHeightSelector=".t3js-preset-custom-height",e.changeOrientationSelector=".t3js-change-orientation",e.changePresetSelector=".t3js-change-preset",e.inputWidthSelector=".t3js-viewpage-input-width",e.inputHeightSelector=".t3js-viewpage-input-height",e.currentLabelSelector=".t3js-viewpage-current-label",e.topbarContainerSelector=".t3js-viewpage-topbar"}(i||(i={}));class s{constructor(){this.defaultLabel="",this.minimalHeight=300,this.minimalWidth=300,this.storagePrefix="moduleData.web_view.States.",this.queue=[],this.queueIsRunning=!1,e(()=>{const t=e(".t3js-preset-custom-label");this.defaultLabel=t.length>0?t.html().trim():"",this.$iframe=e("#tx_this_iframe"),this.$resizableContainer=e(i.resizableContainerIdentifier),this.$sizeSelector=e(i.sizeIdentifier),this.initialize()})}static getCurrentWidth(){return e(i.inputWidthSelector).val()}static getCurrentHeight(){return e(i.inputHeightSelector).val()}static setLabel(t){e(i.currentLabelSelector).html(t)}static getCurrentLabel(){return e(i.currentLabelSelector).html().trim()}persistQueue(){if(!1===this.queueIsRunning&&this.queue.length>=1){this.queueIsRunning=!0;let e=this.queue.shift();t.set(e.storageIdentifier,e.data).done(()=>{this.queueIsRunning=!1,this.persistQueue()})}}addToQueue(e,t){const i={storageIdentifier:e,data:t};this.queue.push(i),this.queue.length>=1&&this.persistQueue()}setSize(t,s){isNaN(s)&&(s=this.calculateContainerMaxHeight()),s<this.minimalHeight&&(s=this.minimalHeight),isNaN(t)&&(t=this.calculateContainerMaxWidth()),t<this.minimalWidth&&(t=this.minimalWidth),e(i.inputWidthSelector).val(t),e(i.inputHeightSelector).val(s),this.$resizableContainer.css({width:t,height:s,left:0})}persistCurrentPreset(){let e={width:s.getCurrentWidth(),height:s.getCurrentHeight(),label:s.getCurrentLabel()};this.addToQueue(this.storagePrefix+"current",e)}persistCustomPreset(){let t={width:s.getCurrentWidth(),height:s.getCurrentHeight()};e(i.customSelector).data("width",t.width),e(i.customSelector).data("height",t.height),e(i.customWidthSelector).html(t.width),e(i.customHeightSelector).html(t.height),this.addToQueue(this.storagePrefix+"custom",t)}persistCustomPresetAfterChange(){clearTimeout(this.queueDelayTimer),this.queueDelayTimer=window.setTimeout(()=>{this.persistCustomPreset()},1e3)}initialize(){e(document).on("click",i.changeOrientationSelector,()=>{const t=e(i.inputHeightSelector).val(),s=e(i.inputWidthSelector).val();this.setSize(t,s),this.persistCurrentPreset()}),e(document).on("change",i.inputWidthSelector,()=>{const t=e(i.inputWidthSelector).val(),r=e(i.inputHeightSelector).val();this.setSize(t,r),s.setLabel(this.defaultLabel),this.persistCustomPresetAfterChange()}),e(document).on("change",i.inputHeightSelector,()=>{const t=e(i.inputWidthSelector).val(),r=e(i.inputHeightSelector).val();this.setSize(t,r),s.setLabel(this.defaultLabel),this.persistCustomPresetAfterChange()}),e(document).on("click",i.changePresetSelector,t=>{const i=e(t.currentTarget).data();this.setSize(parseInt(i.width,10),parseInt(i.height,10)),s.setLabel(i.label),this.persistCurrentPreset()}),this.$resizableContainer.resizable({handles:"w, sw, s, se, e"}),this.$resizableContainer.on("resizestart",t=>{e(t.currentTarget).append('<div id="this-iframe-cover" style="z-index:99;position:absolute;width:100%;top:0;left:0;height:100%;"></div>')}),this.$resizableContainer.on("resize",(t,r)=>{r.size.width=r.originalSize.width+2*(r.size.width-r.originalSize.width),r.size.height<this.minimalHeight&&(r.size.height=this.minimalHeight),r.size.width<this.minimalWidth&&(r.size.width=this.minimalWidth),e(i.inputWidthSelector).val(r.size.width),e(i.inputHeightSelector).val(r.size.height),this.$resizableContainer.css({left:0}),s.setLabel(this.defaultLabel)}),this.$resizableContainer.on("resizestop",()=>{e("#viewpage-iframe-cover").remove(),this.persistCurrentPreset(),this.persistCustomPreset()})}calculateContainerMaxHeight(){this.$resizableContainer.hide();let t=e(i.moduleBodySelector),s=t.outerHeight()-t.height(),r=e(document).height(),h=e(i.topbarContainerSelector).outerHeight();return this.$resizableContainer.show(),r-s-h-8}calculateContainerMaxWidth(){this.$resizableContainer.hide();let t=e(i.moduleBodySelector),s=t.outerWidth()-t.width(),r=e(document).width();return this.$resizableContainer.show(),parseInt(r-s+"",10)}}return new s}));