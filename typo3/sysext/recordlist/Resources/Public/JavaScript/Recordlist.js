/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","TYPO3/CMS/Backend/Icons","TYPO3/CMS/Backend/Storage/Persistent","TYPO3/CMS/Core/Event/RegularEvent","TYPO3/CMS/Backend/Viewport"],(function(t,e,i,a,n){"use strict";return new class{constructor(){this.identifier={entity:".t3js-entity",toggle:".t3js-toggle-recordlist",localize:".t3js-action-localize",icons:{collapse:"actions-view-list-collapse",expand:"actions-view-list-expand",editMultiple:".t3js-record-edit-multiple"}},this.toggleClick=a=>{a.preventDefault();const n=t(a.currentTarget),s=n.data("table"),l=t(n.data("target")),d="expanded"===l.data("state"),o=n.find(".collapseIcon"),r=d?this.identifier.icons.expand:this.identifier.icons.collapse;e.getIcon(r,e.sizes.small).done(t=>{o.html(t)});let c={};i.isset("moduleData.list")&&(c=i.get("moduleData.list"));const u={};u[s]=d?1:0,t.extend(!0,c,u),i.set("moduleData.list",c).done(()=>{l.data("state",d?"collapsed":"expanded")})},this.onEditMultiple=e=>{let i,a,n,s,l;e.preventDefault(),i=t(e.currentTarget).closest("[data-table]"),0!==i.length&&(s=t(e.currentTarget).data("uri"),a=i.data("table"),n=i.find(this.identifier.entity+'[data-uid][data-table="'+a+'"]').map((e,i)=>t(i).data("uid")).toArray().join(","),l=s.match(/{[^}]+}/g),t.each(l,(e,i)=>{const l=i.substr(1,i.length-2).split(":");let d;switch(l.shift()){case"entityIdentifiers":d=n;break;case"T3_THIS_LOCATION":d=T3_THIS_LOCATION;break;default:return}t.each(l,(t,e)=>{"editList"===e&&(d=this.editList(a,d))}),s=s.replace(i,d)}),window.location.href=s)},this.disableButton=e=>{t(e.currentTarget).prop("disable",!0).addClass("disabled")},this.deleteRow=e=>{const i=e.detail.payload;if(i.hasErrors)return;if("datahandler"===i.component)return;const a=t(`table[data-table="${i.table}"]`),s=a.find(`tr[data-uid="${i.uid}"]`),l=a.closest(".panel"),d=l.find(".panel-heading"),o=a.find(`[data-l10nparent="${i.uid}"]`),r=t().add(s).add(o);if(r.fadeTo("slow",.4,()=>{r.slideUp("slow",()=>{r.remove(),0===a.find("tbody tr").length&&l.slideUp("slow")})}),"0"===s.data("l10nparent")||""===s.data("l10nparent")){const t=Number(d.find(".t3js-table-total-items").html());d.find(".t3js-table-total-items").text(t-1)}"pages"===i.table&&n.NavigationContainer.PageTree.refreshTree()},t(document).on("click",this.identifier.toggle,this.toggleClick),t(document).on("click",this.identifier.icons.editMultiple,this.onEditMultiple),t(document).on("click",this.identifier.localize,this.disableButton),new a("typo3:datahandler:delete",this.deleteRow).bindTo(document)}editList(t,e){const i=[];let a=0,n=e.indexOf(",");for(;-1!==n;)this.getCheckboxState(t+"|"+e.substr(a,n-a))&&i.push(e.substr(a,n-a)),a=n+1,n=e.indexOf(",",a);return this.getCheckboxState(t+"|"+e.substr(a))&&i.push(e.substr(a)),i.length>0?i.join(","):e}getCheckboxState(t){const e="CBC["+t+"]";return document.querySelector('form[name="dblistForm"] [name="'+e+'"]').checked}}}));