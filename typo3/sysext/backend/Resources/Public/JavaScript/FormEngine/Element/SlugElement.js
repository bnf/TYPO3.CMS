/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","TYPO3/CMS/Core/Ajax/AjaxRequest"],(function(e,i){"use strict";var t,l;!function(e){e.toggleButton=".t3js-form-field-slug-toggle",e.recreateButton=".t3js-form-field-slug-recreate",e.inputField=".t3js-form-field-slug-input",e.readOnlyField=".t3js-form-field-slug-readonly",e.hiddenField=".t3js-form-field-slug-hidden"}(t||(t={})),function(e){e.AUTO="auto",e.RECREATE="recreate",e.MANUAL="manual"}(l||(l={}));return class{constructor(i,l){this.options=null,this.$fullElement=null,this.manuallyChanged=!1,this.$readOnlyField=null,this.$inputField=null,this.$hiddenField=null,this.request=null,this.fieldsToListenOn={},this.options=l,this.fieldsToListenOn=this.options.listenerFieldNames||{},e(()=>{this.$fullElement=e(i),this.$inputField=this.$fullElement.find(t.inputField),this.$readOnlyField=this.$fullElement.find(t.readOnlyField),this.$hiddenField=this.$fullElement.find(t.hiddenField),this.registerEvents()})}registerEvents(){const i=Object.keys(this.getAvailableFieldsForProposalGeneration()).map(e=>this.fieldsToListenOn[e]);i.length>0?("new"===this.options.command&&e(this.$fullElement).on("keyup",i.join(","),()=>{this.manuallyChanged||this.sendSlugProposal(l.AUTO)}),e(this.$fullElement).on("click",t.recreateButton,e=>{e.preventDefault(),this.$readOnlyField.hasClass("hidden")&&(this.$readOnlyField.toggleClass("hidden",!1),this.$inputField.toggleClass("hidden",!0)),this.sendSlugProposal(l.RECREATE)})):e(this.$fullElement).find(t.recreateButton).addClass("disabled").prop("disabled",!0),e(this.$inputField).on("keyup",()=>{this.manuallyChanged=!0,this.sendSlugProposal(l.MANUAL)}),e(this.$fullElement).on("click",t.toggleButton,e=>{e.preventDefault();const i=this.$readOnlyField.hasClass("hidden");this.$readOnlyField.toggleClass("hidden",!i),this.$inputField.toggleClass("hidden",i),i?(this.$inputField.val()!==this.$readOnlyField.val()?this.$readOnlyField.val(this.$inputField.val()):(this.manuallyChanged=!1,this.$fullElement.find(".t3js-form-proposal-accepted").addClass("hidden"),this.$fullElement.find(".t3js-form-proposal-different").addClass("hidden")),this.$hiddenField.val(this.$readOnlyField.val())):this.$hiddenField.val(this.$inputField.val())})}sendSlugProposal(t){const s={};t===l.AUTO||t===l.RECREATE?(e.each(this.getAvailableFieldsForProposalGeneration(),(i,t)=>{s[i]=e('[data-formengine-input-name="'+t+'"]').val()}),!0===this.options.includeUidInValues&&(s.uid=this.options.recordId.toString())):s.manual=this.$inputField.val(),this.request instanceof i&&this.request.abort(),this.request=new i(TYPO3.settings.ajaxUrls.record_slug_suggest),this.request.post({values:s,mode:t,tableName:this.options.tableName,pageId:this.options.pageId,parentPageId:this.options.parentPageId,recordId:this.options.recordId,language:this.options.language,fieldName:this.options.fieldName,command:this.options.command,signature:this.options.signature}).then(async e=>{const i=await e.resolve(),s="/"+i.proposal.replace(/^\//,"");i.hasConflicts?(this.$fullElement.find(".t3js-form-proposal-accepted").addClass("hidden"),this.$fullElement.find(".t3js-form-proposal-different").removeClass("hidden").find("span").text(s)):(this.$fullElement.find(".t3js-form-proposal-accepted").removeClass("hidden").find("span").text(s),this.$fullElement.find(".t3js-form-proposal-different").addClass("hidden")),this.$hiddenField.val()!==i.proposal&&this.$fullElement.find("input").trigger("change"),t===l.AUTO||t===l.RECREATE?(this.$readOnlyField.val(i.proposal),this.$hiddenField.val(i.proposal),this.$inputField.val(i.proposal)):this.$hiddenField.val(i.proposal)}).finally(()=>{this.request=null})}getAvailableFieldsForProposalGeneration(){const i={};return e.each(this.fieldsToListenOn,(t,l)=>{e('[data-formengine-input-name="'+l+'"]').length>0&&(i[t]=l)}),i}}}));