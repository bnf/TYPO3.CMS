/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["./Enum/Viewport/ScaffoldIdentifier","jquery","./Storage/Persistent","./Viewport","./Event/ClientRequest","./Event/TriggerRequest","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Core/Event/RegularEvent"],(function(e,t,n,o,a,i,d,l){"use strict";class r{constructor(){this.loadedModule=null,this.loadedNavigationComponentId="",t(()=>this.initialize())}static getCollapsedMainMenuItems(){return n.isset("modulemenu")?JSON.parse(n.get("modulemenu")):{}}static addCollapsedMainMenuItem(e){const t=r.getCollapsedMainMenuItems();t[e]=!0,n.set("modulemenu",JSON.stringify(t))}static removeCollapseMainMenuItem(e){const t=this.getCollapsedMainMenuItems();delete t[e],n.set("modulemenu",JSON.stringify(t))}static includeId(e,t){if(!e.navigationComponentId&&!e.navigationFrameScript)return t;let n="";return n="TYPO3/CMS/Backend/PageTree/PageTreeElement"===e.navigationComponentId?"web":e.name.split("_")[0],top.fsMod.recentIds[n]&&(t="id="+top.fsMod.recentIds[n]+"&"+t),t}static toggleMenu(a){o.NavigationContainer.cleanup();const i=t(e.ScaffoldIdentifierEnum.scaffold);void 0===a&&(a=i.hasClass("scaffold-modulemenu-expanded")),i.toggleClass("scaffold-modulemenu-expanded",!a),a||t(".scaffold").removeClass("scaffold-search-expanded").removeClass("scaffold-toolbar-expanded"),n.set("BackendComponents.States.typo3-module-menu",{collapsed:a}),o.doLayout()}static getRecordFromName(e){const n=t("#"+e);return{name:e,navigationComponentId:n.data("navigationcomponentid"),navigationFrameScript:n.data("navigationframescript"),navigationFrameScriptParam:n.data("navigationframescriptparameters"),link:n.data("link")}}static highlightModuleMenuItem(e){t(".modulemenu-action.modulemenu-action-active").removeClass("modulemenu-action-active"),t("#"+e).addClass("modulemenu-action-active")}refreshMenu(){new d(TYPO3.settings.ajaxUrls.modulemenu).get().then(async e=>{const t=await e.resolve();document.getElementById("modulemenu").outerHTML=t.menu,top.currentModuleLoaded&&r.highlightModuleMenuItem(top.currentModuleLoaded),o.doLayout()})}reloadFrames(){o.NavigationContainer.refresh(),o.ContentContainer.refresh()}showModule(e,t,n=null){t=t||"";const o=r.getRecordFromName(e);return this.loadModuleComponents(o,t,new a("typo3.showModule",n))}initialize(){const e=this;let n=t.Deferred();if(n.resolve(),top.startInModule&&top.startInModule[0]&&t("#"+top.startInModule[0]).length>0)n=this.showModule(top.startInModule[0],top.startInModule[1]);else{const e=t(".t3js-modulemenu-action[data-link]:first");e.attr("id")&&(n=this.showModule(e.attr("id")))}n.then(()=>{e.initializeEvents()})}initializeEvents(){new l("click",(e,n)=>{const a=n.closest(".modulemenu-group"),i=a.querySelector(".modulemenu-group-container"),d="true"===n.attributes.getNamedItem("aria-expanded").value;d?r.addCollapsedMainMenuItem(n.id):r.removeCollapseMainMenuItem(n.id),a.classList.toggle(".modulemenu-group-collapsed",d),a.classList.toggle(".modulemenu-group-expanded",!d),n.attributes.getNamedItem("aria-expanded").value=(!d).toString(),t(i).stop().slideToggle({complete:function(){o.doLayout()}})}).delegateTo(document,".t3js-modulemenu .t3js-modulemenu-collapsible"),new l("click",(e,t)=>{void 0!==t.dataset.link&&(e.preventDefault(),this.showModule(t.id,"",e))}).delegateTo(document,".t3js-modulemenu-action"),new l("click",e=>{e.preventDefault(),r.toggleMenu()}).bindTo(document.querySelector(".t3js-topbar-button-modulemenu")),new l("click",e=>{e.preventDefault(),r.toggleMenu(!0)}).bindTo(document.querySelector(".t3js-scaffold-content-overlay")),new l("click",e=>{e.preventDefault(),o.NavigationContainer.toggle()}).bindTo(document.querySelector(".t3js-topbar-button-navigationcomponent"))}loadModuleComponents(e,n,a){const d=e.name,l=o.ContentContainer.beforeSetUrl(a);return l.then(t.proxy(()=>{e.navigationComponentId?this.loadNavigationComponent(e.navigationComponentId):e.navigationFrameScript?(o.NavigationContainer.show("typo3-navigationIframe"),this.openInNavFrame(e.navigationFrameScript,e.navigationFrameScriptParam,new i("typo3.loadModuleComponents",a))):o.NavigationContainer.hide(),r.highlightModuleMenuItem(d),this.loadedModule=d,n=r.includeId(e,n),this.openInContentFrame(e.link,n,new i("typo3.loadModuleComponents",a)),top.currentSubScript=e.link,top.currentModuleLoaded=d,o.doLayout()},this)),l}loadNavigationComponent(e){const n=this;if(o.NavigationContainer.show(e),e===this.loadedNavigationComponentId)return;const a=e.replace(/[/]/g,"_");""!==this.loadedNavigationComponentId&&t("#navigationComponent-"+this.loadedNavigationComponentId.replace(/[/]/g,"_")).hide(),t('.t3js-scaffold-content-navigation [data-component="'+e+'"]').length<1&&t(".t3js-scaffold-content-navigation").append(t("<div />",{class:"scaffold-content-navigation-component","data-component":e,id:"navigationComponent-"+a})),window.require([e],t=>{t.initialize("#navigationComponent-"+a),o.NavigationContainer.show(e),n.loadedNavigationComponentId=e})}openInNavFrame(e,t,n){const a=e+(t?(e.includes("?")?"&":"?")+t:""),d=o.NavigationContainer.getUrl(),l=o.NavigationContainer.setUrl(e,new i("typo3.openInNavFrame",n));return d!==a&&("resolved"===l.state()?o.NavigationContainer.refresh():l.then(o.NavigationContainer.refresh)),l}openInContentFrame(e,t,n){let a;if(top.nextLoadModuleUrl)a=o.ContentContainer.setUrl(top.nextLoadModuleUrl,new i("typo3.openInContentFrame",n)),top.nextLoadModuleUrl="";else{const d=e+(t?(e.includes("?")?"&":"?")+t:"");a=o.ContentContainer.setUrl(d,new i("typo3.openInContentFrame",n))}return a}}top.TYPO3.ModuleMenu||(top.TYPO3.ModuleMenu={App:new r});return top.TYPO3.ModuleMenu}));